# Firehydrant

Integration to import information from Firehydrant into Port.

The integration supports importing environments, services, incidents and retrospectives from your Firehydrant account to Port, according to your mapping and definition.

## Development Requirements

- Python3.11.0
- Poetry (Python Package Manager)
- Port-Ocean

## Deployment to Port

For more information about the installation visit the [Port Ocean helm chart](https://github.com/port-labs/helm-charts/tree/main/charts/port-ocean)

```bash
# The following script will install an Ocean integration in your K8s cluster using helm
# integration.identifier: Change the identifier to describe your integration
# integration.config.appHost: The host of the Port Ocean app. Used to set up the integration endpoint as the target for Webhooks created in Firehydrant
# integration.config.apiUrl: The URL of your Firehydrant API, for example: https://api.firehydrant.io
# integration.secrets.token: Firehydrant API token generated by the user

helm upgrade --install my-firehydrant-integration port-labs/port-ocean \
	--set port.clientId="CLIENT_ID"  \
	--set port.clientSecret="CLIENT_SECRET"  \
	--set initializePortResources=true  \
	--set integration.identifier="my-firehydrant-integration"  \
	--set integration.type="firehydrant"  \
	--set integration.eventListener.type="POLLING"  \
	--set integration.config.apiUrl="https://api.firehydrant.io"  \
	--set integration.secrets.token="<FIREHYDRANT_API_TOKEN>"
```

## Supported Kinds

### Environment

The mapping should refer to one of the environment from the example response: [Firehydrant documentation](https://developers.firehydrant.com/#/operations/getV1Environments)

<details>
<summary>blueprints.json</summary>

```json
{
	"identifier": "firehydrantEnvironment",
	"description": "This blueprint represents a firehydrant environment",
	"title": "FireHydrant Environment",
	"icon": "Firehydrant",
	"schema": {
		"properties": {
			"description": {
				"title": "Description",
				"type": "string"
			},
			"activeIncidents": {
				"title": "Active Incidents",
				"type": "number",
				"description": "Number of active incidents attached to this environment"
			},
			"createdAt": {
				"title": "Created At",
				"type": "string",
				"format": "date-time"
			},
			"updatedAt": {
				"title": "Updated At",
				"type": "string",
				"format": "date-time"
			}
		},
		"required": []
	},
	"mirrorProperties": {},
	"calculationProperties": {},
	"relations": {}
}
```

</details>
<details>
  <summary>port-app-config.yaml</summary>

```yaml
resources:
  - kind: environment
    selector:
      query: 'true'
    port:
      entity:
        mappings:
          blueprint: '"firehydrantEnvironment"'
          identifier: .id
          title: .name
          properties:
              description: .description
              activeIncidents: .active_incidents | length
              createdAt: .created_at
              updatedAt: .updated_at
```

</details>

### Service

The mapping should refer to one of the services in the example response: [Firehydrant documentation](https://developers.firehydrant.com/#/operations/getV1Services)

<details>
<summary>blueprints.json</summary>

```json
{
	"identifier": "firehydrantService",
	"description": "This blueprint represents a firehydrant service",
	"title": "FireHydrant Service",
	"icon": "Firehydrant",
	"schema": {
		"properties": {
			"description": {
				"title": "Description",
				"type": "string",
				"icon": "DefaultProperty"
			},
			"slug": {
				"title": "Slug",
				"type": "string",
				"icon": "DefaultProperty"
			},
			"links": {
				"title": "Links",
				"type": "array",
				"icon": "DefaultProperty"
			},
			"labels": {
				"icon": "DefaultProperty",
				"title": "Labels",
				"type": "object"
			},
			"owner": {
				"title": "Team",
				"type": "string",
				"icon": "DefaultProperty"
			},
			"createdAt": {
				"title": "Created At",
				"type": "string",
				"format": "date-time",
				"icon": "DefaultProperty"
			},
			"updatedAt": {
				"title": "Updated At",
				"type": "string",
				"format": "date-time",
				"icon": "DefaultProperty"
			},
			"activeIncidents": {
				"title": "Active Incidents",
				"type": "number",
				"description": "Number of active incidents attached to this service"
			},
			"meanTimeToAcknowledge": {
				"title": "Mean Time to Acknowledge",
				"type": "number"
			},
			"meanTimeToDetect": {
				"title": "Mean Time to Detection",
				"type": "number"
			},
			"meanTimeToMitigate": {
				"title": "Mean Time to Mitigation",
				"type": "number"
			},
			"meanTimeToResolve": {
				"title": "Mean Time to Resolution",
				"type": "number"
			}
		},
		"required": []
	},
	"mirrorProperties": {},
	"calculationProperties": {},
	"relations": {}
}
```

</details>
<details>
  <summary>port-app-config.yaml</summary>

```yaml
resources:
  - kind: service
    selector:
      query: 'true'
    port:
      entity:
        mappings:
          blueprint: '"firehydrantService"'
          identifier: .id
          title: .name
          properties:
              description: .description
              slug: .slug
              links: .links[].href_url
              labels: .labels
              owner: .owner.name
              activeIncidents: .active_incidents | length
              meanTimeToAcknowledge: .__incidentMetrics.time_to_acknowledge
              meanTimeToDetect: .__incidentMetrics.time_to_identify
              meanTimeToMitigate: .__incidentMetrics.time_to_mitigate
              meanTimeToResolve: .__incidentMetrics.time_to_resolve
              createdAt: .created_at
              updatedAt: .updated_at
```

</details>

### Incident

The mapping should refer to one of the incidents in the example response: [Firehydrant documentation](https://developers.firehydrant.com/#/operations/getV1Incidents)

<details>
<summary>blueprints.json</summary>

```json
{
	"identifier": "firehydrantIncident",
	"description": "This blueprint represents a firehydrant incident",
	"title": "FireHydrant Incident",
	"icon": "Firehydrant",
	"schema": {
		"properties": {
			"url": {
				"type": "string",
				"title": "Incident URL",
				"format": "url",
				"description": "the link to the incident"
			},
			"priority": {
				"title": "Priority",
				"type": "string",
				"enum": [
					"P1",
					"P2",
					"P3",
					"P4"
				],
				"enumColors": {
					"P1": "red",
					"P2": "red",
					"P3": "orange",
					"P4": "orange"
				}
			},
			"severity": {
				"title": "Severity",
				"type": "string"
			},
			"tags": {
				"title": "Tags",
				"type": "array"
			},
			"currentMilestone": {
				"type": "string",
				"title": "Current Milestone",
				"default": "started",
				"enum": [
					"started",
					"detected",
					"acknowledged",
					"investigating",
					"identified",
					"mitigated",
					"resolved",
					"postmortem_started",
					"postmortem_completed",
					"closed"
				],
				"enumColors": {
					"started": "red",
					"detected": "red",
					"acknowledged": "orange",
					"investigating": "yellow",
					"identified": "yellow",
					"mitigated": "green",
					"resolved": "green",
					"postmortem_started": "purple",
					"postmortem_completed": "blue",
					"closed": "green"
				}
			},
			"functionalities": {
				"title": "Functionalities Impacted",
				"type": "array"
			},
			"customerImpact": {
				"title": "Customers Impacted",
				"type": "string"
			},
			"createdBy": {
				"title": "Created By",
				"type": "string",
				"format": "user",
				"icon": "TwoUsers"
			},
			"createdAt": {
				"title": "Created At",
				"type": "string",
				"format": "date-time"
			},
			"description": {
				"title": "Description",
				"type": "string"
			},
			"commander": {
				"title": "Commander",
				"type": "string",
				"format": "user",
				"icon": "TwoUsers"
			}
		},
		"required": []
	},
	"mirrorProperties": {},
	"calculationProperties": {},
	"relations": {
		"environment": {
			"title": "Impacted Environments",
			"target": "firehydrantEnvironment",
			"required": false,
			"many": true
		},
		"service": {
			"title": "Impacted Services",
			"target": "firehydrantService",
			"required": false,
			"many": true
		}
	}
}
```

</details>
<details>
  <summary>port-app-config.yaml</summary>

```yaml
resources:
  - kind: incident
    selector:
      query: 'true'
    port:
      entity:
        mappings:
          blueprint: '"firehydrantIncident"'
          identifier: .id
          title: .name
          properties:
              url: .incident_url
              priority: .priority
              severity: .severity
              tags: .tag_list
              currentMilestone: .current_milestone
              functionalities: .functionalities[].name
              description: .description
              customerImpact: .customers_impacted
              commander: .role_assignments[] | select(.incident_role.name == "Commander") | .user.email
              createdBy: .created_by.email
              createdAt: .created_at
          relations:
            environment: .environments | map(.id)
            service: .services | map(.id)
```
</details>

### Retrospective

The mapping should refer to one of the retrospectives in the example response: [Firehydrant documentation](https://developers.firehydrant.com/#/operations/getV1PostMortemsReports)

<details>
<summary>blueprints.json</summary>

```json
{
	"identifier": "firehydrantRetrospective",
	"description": "This blueprint represents a service in our software catalog",
	"title": "FireHydrant Retrospective",
	"icon": "Firehydrant",
	"schema": {
		"properties": {
			"url": {
				"type": "string",
				"title": "Incident URL",
				"format": "url",
				"description": "the link to the incident",
				"icon": "DefaultProperty"
			},
			"tags": {
				"title": "Tags",
				"type": "array",
				"icon": "DefaultProperty"
			},
			"services": {
				"title": "Services Impacted",
				"type": "array",
				"icon": "DefaultProperty"
			},
			"environments": {
				"title": "Environments Impacted",
				"type": "array",
				"icon": "DefaultProperty"
			},
			"functionalities": {
				"title": "Functionalities Impacted",
				"type": "array",
				"icon": "DefaultProperty"
			},
			"createdBy": {
				"title": "Created By",
				"type": "string",
				"format": "user",
				"icon": "TwoUsers"
			},
			"createdAt": {
				"title": "Created At",
				"type": "string",
				"format": "date-time",
				"icon": "DefaultProperty"
			},
			"customerImpact": {
				"title": "Customer Impact",
				"type": "string",
				"icon": "DefaultProperty"
			},
			"commander": {
				"title": "Commander",
				"type": "string",
				"format": "user",
				"icon": "TwoUsers"
			},
			"resolvedAt": {
				"title": "Resolved At",
				"type": "string",
				"format": "date-time",
				"icon": "DefaultProperty"
			},
			"publishedAt": {
				"title": "Published At",
				"type": "string",
				"format": "date-time",
				"icon": "DefaultProperty"
			},
			"duration": {
				"icon": "DefaultProperty",
				"title": "Incident Duration (Minutes)",
				"type": "number"
			},
			"completedTasks": {
				"icon": "DefaultProperty",
				"title": "Tasks Completed",
				"type": "number"
			},
			"incompletedTasks": {
				"icon": "DefaultProperty",
				"title": "Tasks Not Completed",
				"type": "number"
			},
			"questions": {
				"title": "Retro Questions and Answers",
				"type": "array",
				"icon": "DefaultProperty"
			}
		},
		"required": []
	},
	"mirrorProperties": {},
	"calculationProperties": {},
	"relations": {
		"incident": {
			"title": "Incident",
			"target": "firehydrantIncident",
			"required": false,
			"many": false
		}
	}
}
```

</details>
<details>
  <summary>port-app-config.yaml</summary>

```yaml
resources:
  - kind: retrospective
    selector:
      query: '.incident.current_milestone == "postmortem_completed"'
    port:
      entity:
        mappings:
          blueprint: '"firehydrantRetrospective"'
          identifier: .id
          title: .name
          properties:
              url: .incident.incident_url
              tags: .tag_list
              services: .incident.services[].name
              environments: .incident.environments[].name
              functionalities: .incident.functionalities[].name
              description: .incident.description
              customerImpact: .incident.customers_impacted
              commander: .incident.role_assignments[] | select(.incident_role.name == "Commander") | .user.email
              createdBy: .incident.created_by.email
              resolvedAt: .incident.milestones[] | select(.type == "resolved") | .created_at
              createdAt: .incident.created_at
              publishedAt: .incident.milestones[] | select(.type == "postmortem_completed") | .created_at
              duration: .__enrichedData.duration
              completedTasks: .__enrichedData.tasks.completed
              incompletedTasks: .__enrichedData.tasks.incompleted
              questions: .__enrichedData.questions
          relations:
            incident: .incident.id
```
</details>

## Development

### Installation

```sh
make install
```

### Runnning Localhost

```sh
make run
```

or

```sh
ocean sail
```

### Running Tests

`make test`

### Access Swagger Documentation

> <http://localhost:8080/docs>

### Access Redoc Documentation

> <http://localhost:8080/redoc>

### Folder Structure

The Firehydrant integration suggested folder structure is as follows:

```
firehydrant/
├─ main.py
├─ pyproject.toml
└─ Dockerfile
```